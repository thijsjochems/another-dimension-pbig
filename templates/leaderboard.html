<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Leaderboard - Murder Mystery</title>
    <link rel="stylesheet" href="/static/fonts.css">
    <style>
        /* === COLOR PALETTE === */
        :root {
            --color-bg: #001C0F;           /* Dark green background */
            --color-primary: #54FCBC;      /* Bright teal (text, accents) */
            --color-secondary: #DCFFED;    /* Light mint (subtle text) */
            --color-dark: #1E1E1E;         /* Dark gray (borders, shadows) */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-body);
            background-color: var(--color-bg);
            min-height: 100vh;
            color: var(--color-primary);
            padding: 40px 20px;
        }
        
        .leaderboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            position: relative;
            z-index: 100;
            background: var(--color-bg);
            padding-bottom: 20px;
            padding-top: 20px;
        }
        
        .robot-logo {
            width: 60px;
            height: 60px;
            opacity: 0.6;
            filter: drop-shadow(0 0 15px rgba(84, 252, 188, 0.3));
        }
        
        .robot-logo.flipped {
            transform: scaleX(-1);
        }
        
        h1 {
            font-size: 3.5rem;
            color: var(--color-primary);
            margin: 0;
            letter-spacing: 10px;
            text-transform: uppercase;
            text-shadow: 0 0 30px rgba(84, 252, 188, 0.4);
        }

        .subtitle {
            text-align: center;
            color: var(--color-secondary);
            font-size: 1.3rem;
            margin-bottom: 50px;
            letter-spacing: 3px;
            opacity: 0.8;
            position: relative;
            z-index: 100;
            background: var(--color-bg);
            padding: 10px 0;
        }
        
        /* Unified leaderboard with auto-scroll */
        .unified-leaderboard {
            background: var(--color-bg);
            border: 2px solid rgba(84, 252, 188, 0.3);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .leaderboard-table {
            width: 100%;
            position: relative;
            table-layout: fixed;
            box-shadow: 0 2px 0 0 var(--color-primary);
            z-index: 10;
        }
        
        .leaderboard-table thead th:nth-child(1),
        .leaderboard-table tbody td:nth-child(1) {
            width: 100px;
            text-align: center;
        }
        
        .leaderboard-table thead th:nth-child(2),
        .leaderboard-table tbody td:nth-child(2) {
            width: auto;
        }
        
        .leaderboard-table thead th:nth-child(3),
        .leaderboard-table tbody td:nth-child(3) {
            width: 150px;
        }
        
        .leaderboard-table thead th:nth-child(4),
        .leaderboard-table tbody td:nth-child(4) {
            width: 170px;
        }
        
        .leaderboard-table > tbody {
            position: relative;
            z-index: 20;
            background: var(--color-bg);
        }
        
        /* Thick border after top 3 - highest priority */
        .top-three-separator {
            border-bottom: 4px solid rgba(84, 252, 188, 0.5) !important;
            position: relative;
            z-index: 25;
        }
        
        .top-three-separator td {
            position: relative;
            background: var(--color-bg);
            z-index: 25;
        }
        
        .scrollable-wrapper {
            max-height: 400px;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }
        
        .scrollable-wrapper tbody {
            transition: transform 1s ease-in-out;
        }
        
        .scrollable-wrapper tr {
            border-bottom: none !important;
        }
        
        .scrollable-wrapper td {
            border-bottom: none !important;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--color-bg);
            border-bottom: 2px solid var(--color-primary);
            position: sticky;
            top: 0;
            z-index: 20;
        }
        
        thead th {
            background: var(--color-bg);
            padding: 25px 20px;
        }
        
        th {
            padding: 25px 20px;
            text-align: left;
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--color-primary);
        }
        
        tbody tr {
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(84, 252, 188, 0.1);
        }

        tbody tr:last-child {
            border-bottom: none;
        }
        
        td {
            padding: 25px 20px;
            font-size: 1.1rem;
            color: var(--color-secondary);
        }
        
        tbody tr:hover {
            background: rgba(84, 252, 188, 0.08);
            box-shadow: 0 0 20px rgba(84, 252, 188, 0.2);
        }
        
        .rank {
            font-weight: bold;
            font-size: 2rem;
            text-align: center;
            width: 100px;
            color: var(--color-primary);
        }
        
        .rank-1 {
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }
        
        .rank-2 {
            color: #C0C0C0;
            text-shadow: 0 0 15px rgba(192, 192, 192, 0.6);
        }
        
        .rank-3 {
            color: #CD7F32;
            text-shadow: 0 0 15px rgba(205, 127, 50, 0.6);
        }
        
        .medal-icon {
            width: 30px;
            height: 30px;
            display: inline-block;
            vertical-align: middle;
        }

        .player-name {
            font-weight: 600;
            color: var(--color-primary);
        }
        
        /* Latest game highlight */
        tr.latest-game {
            background: rgba(84, 252, 188, 0.15) !important;
            box-shadow: inset 0 0 0 2px var(--color-primary);
            position: relative;
        }
        
        tr.latest-game td {
            font-weight: 700;
            color: var(--color-primary);
            text-shadow: 0 0 10px rgba(84, 252, 188, 0.4);
        }
        
        /* Ensure table rows have solid backgrounds */
        tbody tr {
            background: var(--color-bg);
        }
        
        .latest-section {
            margin-top: 40px;
            padding: 30px;
            background: rgba(84, 252, 188, 0.08);
            border: 2px solid var(--color-primary);
            border-radius: 10px;
        }
        
        .latest-section h2 {
            color: var(--color-primary);
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            letter-spacing: 2px;
        }

        .time {
            color: var(--color-primary);
            font-weight: 700;
            font-size: 1.3rem;
            letter-spacing: 1px;
        }
        
        .back-button {
            background: rgba(84, 252, 188, 0.03);
            border: 2px solid var(--color-primary);
            border-radius: 10px;
            padding: 20px 50px;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--color-primary);
            cursor: pointer;
            margin-top: 40px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-family: var(--font-body);
        }
        
        .back-button:hover {
            background: rgba(84, 252, 188, 0.08);
            box-shadow: 0 0 30px rgba(84, 252, 188, 0.3);
            transform: translateY(-3px);
        }
        
        .no-data {
            text-align: center;
            padding: 80px 40px;
            font-size: 1.8rem;
            color: var(--color-secondary);
            opacity: 0.6;
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
                letter-spacing: 5px;
            }

            .robot-logo {
                width: 40px;
                height: 40px;
            }
            
            th, td {
                padding: 15px 10px;
                font-size: 0.9rem;
            }

            .rank {
                font-size: 1.5rem;
                width: 70px;
            }

            .time {
                font-size: 1.1rem;
            }

            .back-button {
                padding: 15px 35px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="leaderboard-container">
        <div class="header">
            <img src="{{ url_for('static', filename='robot-mascot.png') }}" alt="Robot Detective" class="robot-logo">
            <h1>LEADERBOARD</h1>
            <img src="{{ url_for('static', filename='robot-mascot.png') }}" alt="Robot Detective" class="robot-logo flipped">
        </div>
        <p class="subtitle">Wie lost de moord het snelste op?</p>
        
        <div id="topThree" class="top-three" style="display: none;"></div>
        <div id="scrollableLeaderboard" class="scrollable-section" style="display: none;"></div>
        <div class="leaderboard-table" id="leaderboardTable">
            <p class="no-data">Loading...</p>
        </div>
        
        <button class="back-button" onclick="goHome()">‚Üê Terug naar Home</button>
    </div>
    
    <script>
        window.onload = async () => {
            await loadLeaderboard();
        };
        
        // Listen for NFC keyboard input (cijfer + Enter)
        let nfcBuffer = '';
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && nfcBuffer.length > 0) {
                handleNFCScan(nfcBuffer);
                nfcBuffer = '';
            } else if (e.key >= '0' && e.key <= '9') {
                nfcBuffer += e.key;
            }
        });
        
        async function handleNFCScan(code) {
            console.log('üîñ NFC code scanned:', code);
            
            try {
                const response = await fetch('/api/game/scan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({nfc_code: code})
                });
                
                const result = await response.json();
                console.log('Scan result:', result);
                
                if (result.success) {
                    const type = result.type || result.code_type;
                    const data = result.data || {};
                    
                    // Exit, Yes, No = Navigate to home
                    if (type === 'special') {
                        const codeType = data.code_type;
                        if (codeType === 'EXIT' || codeType === 'YES' || codeType === 'NO') {
                            // Cleanup before going home
                            await fetch('/api/game/cleanup', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' }
                            });
                            window.location.href = '/';
                        }
                    }
                }
            } catch (error) {
                console.error('Error scanning NFC:', error);
            }
        }
        
        async function loadLeaderboard() {
            try {
                const response = await fetch('/api/leaderboard');
                const data = await response.json();
                
                if (data.success && data.leaderboard.length > 0) {
                    renderLeaderboard(data.leaderboard, data.latest_game);
                } else {
                    document.getElementById('leaderboardTable').innerHTML = 
                        '<p class="no-data">Nog geen gespeelde games</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('leaderboardTable').innerHTML = 
                    '<p class="no-data">Error loading leaderboard</p>';
            }
        }
        
        let autoScrollInterval = null;
        let currentScrollIndex = 0;
        
        function renderLeaderboard(entries, latestGame) {
            function getMedalSVG(rank) {
                const colors = {
                    1: '#FFD700',  // Gold
                    2: '#C0C0C0',  // Silver
                    3: '#CD7F32'   // Bronze
                };
                
                if (rank > 3) return `#${rank}`;
                
                return `<svg class="medal-icon" viewBox="0 0 24 24" fill="none" stroke="${colors[rank]}" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <text x="12" y="16" text-anchor="middle" fill="${colors[rank]}" font-size="10" font-weight="bold">${rank}</text>
                </svg>`;
            }
            
            const rankClasses = ['rank-1', 'rank-2', 'rank-3'];
            
            // Limit to top 50
            const limitedEntries = entries.slice(0, 50);
            
            // Build unified table
            let html = '<table class="leaderboard-table"><colgroup>';
            html += '<col style="width: 100px;">';
            html += '<col style="width: auto;">';
            html += '<col style="width: 150px;">';
            html += '<col style="width: 170px;">';
            html += '</colgroup><thead><tr>';
            html += '<th style="text-align: center;">Rank</th>';
            html += '<th>Naam</th>';
            html += '<th>Tijd</th>';
            html += '<th>Datum</th>';
            html += '</tr></thead>';
            
            // Top 3 only
            html += '<tbody>';
            limitedEntries.slice(0, 3).forEach((entry, index) => {
                const rankClass = rankClasses[index];
                const latestClass = entry.is_latest ? 'latest-game' : '';
                const medal = getMedalSVG(entry.rank);
                
                html += `<tr class="${latestClass} ${rankClass}">`;
                html += `<td class="rank ${rankClass}">${medal}</td>`;
                html += `<td class="player-name">${entry.player_name || 'Anoniem'}</td>`;
                html += `<td class="time">${entry.total_time}</td>`;
                html += `<td>${new Date(entry.completed_at).toLocaleDateString('nl-NL', {day: 'numeric', month: 'short', year: 'numeric'})}</td>`;
                html += '</tr>';
            });
            html += '</tbody></table>';
            
            // Second table for scrolling (4-50)
            if (limitedEntries.length > 3) {
                html += '<div class="scrollable-wrapper">';
                html += '<table class="leaderboard-table"><colgroup>';
                html += '<col style="width: 100px;">';
                html += '<col style="width: auto;">';
                html += '<col style="width: 150px;">';
                html += '<col style="width: 170px;">';
                html += '</colgroup><tbody id="scrollingRows">';
                
                limitedEntries.slice(3).forEach((entry) => {
                    const latestClass = entry.is_latest ? 'latest-game' : '';
                    const medal = getMedalSVG(entry.rank);
                    
                    html += `<tr class="${latestClass}">`;
                    html += `<td class="rank">${medal}</td>`;
                    html += `<td class="player-name">${entry.player_name || 'Anoniem'}</td>`;
                    html += `<td class="time">${entry.total_time}</td>`;
                    html += `<td>${new Date(entry.completed_at).toLocaleDateString('nl-NL', {day: 'numeric', month: 'short', year: 'numeric'})}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
            }
            
            document.getElementById('leaderboardTable').innerHTML = html;
            
            // Start auto-scroll only if more than 10 entries
            if (limitedEntries.length > 10) {
                startAutoScroll();
            }
        }
        
        function startAutoScroll() {
            const scrollingRows = document.getElementById('scrollingRows');
            if (!scrollingRows) return;
            
            const rows = scrollingRows.querySelectorAll('tr');
            if (rows.length === 0) return;
            
            // Get exact row height
            const firstRow = rows[0];
            const rowHeight = firstRow.getBoundingClientRect().height;
            
            let currentIndex = 0;
            
            // Auto-scroll every 2 seconds
            setInterval(() => {
                currentIndex++;
                
                // Reset when reaching the end
                if (currentIndex >= rows.length) {
                    currentIndex = 0;
                }
                
                const scrollAmount = currentIndex * rowHeight;
                scrollingRows.style.transform = `translateY(-${scrollAmount}px)`;
            }, 2000);
        }
        
        async function goHome() {
            // Cleanup before going home
            await fetch('/api/game/cleanup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            window.location.href = '/';
        }
    </script>
</body>
</html>
