<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Murder Mystery Game</title>
    <link rel="stylesheet" href="/static/fonts.css">
    <style>
        /* === COLOR PALETTE === */
        :root {
            --color-bg: #001C0F;           /* Dark green background */
            --color-primary: #54FCBC;      /* Bright teal (text, accents) */
            --color-secondary: #DCFFED;    /* Light mint (subtle text) */
            --color-dark: #1E1E1E;         /* Dark gray (borders, shadows) */
            --color-success: #00ff00;      /* Success green */
            --color-error: #ff0000;        /* Error red */
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-body);
            background-color: var(--color-bg);
            min-height: 100vh;
            color: var(--color-primary);
            padding: 50px 30px 30px 30px;
            line-height: 1.6;
        }
        
        .game-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-direction: column;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .robot-logo {
            width: 50px;
            height: 50px;
            opacity: 0.6;
            filter: drop-shadow(0 0 10px rgba(84, 252, 188, 0.3));
        }
        
        .robot-logo.flipped {
            transform: scaleX(-1);
        }
        
        .footer-logo {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 400px;
            width: 80%;
            opacity: 0.8;
            filter: drop-shadow(0 0 20px rgba(84, 252, 188, 0.3));
            z-index: 5;
            cursor: pointer;
        }
        
        h1 {
            font-size: 4.5rem;
            color: var(--color-primary);
            margin: 0;
            letter-spacing: 8px;
            text-transform: uppercase;
            line-height: 1.3;
        }
        
        .title-line-1 {
            display: block;
        }
        
        .title-line-2 {
            display: block;
        }
        
        .split-container {
            position: relative;
            display: inline-block;
        }
        
        .split-top {
            display: block;
            background: var(--color-bg);
            clip-path: polygon(0 0, 100% 0, 100% 51%, 0 51%);
            transform: translateX(-3px);
            line-height: 1.3;
        }
        
        .split-bottom {
            display: block;
            background: var(--color-bg);
            clip-path: polygon(0 51%, 100% 51%, 100% 100%, 0 100%);
            position: absolute;
            top: 0;
            left: 0;
            line-height: 1.3;
        }
        
        .timer-box {
            background: rgba(84, 252, 188, 0.05);
            border: 2px solid var(--color-primary);
            border-radius: 5px;
            padding: 50px;
            padding-top: 40px;
            padding-bottom: 60px;
            font-size: 7.5rem;
            font-weight: bold;
            color: var(--color-primary);
            margin-bottom: 30px;
            text-align: center;
            letter-spacing: 10px;
            text-shadow: 0 0 15px rgba(84, 252, 188, 0.6);
            position: relative;
            font-variant-numeric: tabular-nums;
        }
        
        .penalty-counter {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 2rem;
            color: #54FCBC;
            font-weight: bold;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(84, 252, 188, 0.8);
        }
        
        .situatie-box {
            background: rgba(84, 252, 188, 0.05);
            border: 2px solid var(--color-primary);
            border-radius: 5px;
            padding: 35px;
            margin-top: 40px;
            margin-bottom: 35px;
            text-align: center;
            font-size: 2rem;
            color: var(--color-secondary);
            line-height: 1.9;
            min-height: 140px;
        }
        
        .team-name-box {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }
        
        .team-name-label {
            font-size: 0.9rem;
            color: rgba(84, 252, 188, 0.6);
            font-family: 'Blender', sans-serif;
            letter-spacing: 1px;
            margin-bottom: 3px;
        }
        
        .team-name-value {
            font-size: 1.1rem;
            color: var(--color-primary);
            font-family: 'Blender', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 2px;
        }
        
        .scenario-box {
            background: rgba(84, 252, 188, 0.02);
            border: 1px solid var(--color-primary);
            border-radius: 5px;
            padding: 40px;
            margin-bottom: 50px;
            line-height: 2;
            font-size: 1.2rem;
            color: var(--color-secondary);
            display: none;
        }
        
        .scenario-box.dev-mode {
            display: block;
        }
        
        .answer-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin-top: 45px;
            margin-bottom: 50px;
        }
        
        .answer-box {
            background: rgba(84, 252, 188, 0.03);
            border: 2px solid rgba(84, 252, 188, 0.3);
            border-radius: 5px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .answer-box.filled {
            border-color: var(--color-primary);
            background: rgba(84, 252, 188, 0.08);
        }
        
        .answer-box.correct {
            border-color: var(--color-success);
            background: rgba(0, 255, 0, 0.1);
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.4);
        }
        
        .answer-box.wrong {
            border-color: var(--color-error);
            background: rgba(255, 0, 0, 0.1);
            animation: shake 0.5s;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.4);
        }
        
        .answer-box:not(.wrong) {
            animation: none;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .answer-label {
            font-size: 2.4rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--color-secondary);
            text-transform: uppercase;
            letter-spacing: 4px;
        }
        
        .answer-icon {
            width: 50px;
            height: 50px;
            margin: 0 auto 15px;
            stroke: var(--color-primary);
            fill: none;
            stroke-width: 2;
            opacity: 0.7;
        }
        
        .answer-subtitle {
            font-size: 1.2rem;
            color: var(--color-secondary);
            opacity: 0.7;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .answer-value {
            font-size: 2.43rem;
            font-weight: bold;
            min-height: 144px;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 3px;
            color: var(--color-primary);
        }
        
        .test-buttons {
            background: rgba(84, 252, 188, 0.02);
            border: 1px solid rgba(84, 252, 188, 0.2);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 30px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 90%;
            width: auto;
            z-index: 9999;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        .test-buttons.dev-visible {
            opacity: 1;
            pointer-events: all;
        }
        
        .test-buttons h3 {
            width: 100%;
            text-align: center;
            margin-bottom: 10px;
            color: var(--color-secondary);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 0.9rem;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }
        
        .button-group strong {
            font-size: 0.85rem;
            margin-right: 5px;
            color: var(--color-secondary);
        }
        
        .test-button {
            background: rgba(84, 252, 188, 0.1);
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75rem;
            font-family: 'Courier New', Courier, monospace;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .test-button svg {
            width: 12px;
            height: 12px;
        }
        
        .test-button:hover {
            background: rgba(84, 252, 188, 0.2);
            border-color: var(--color-primary);
            box-shadow: 0 0 8px rgba(84, 252, 188, 0.3);
        }
        
        .test-button.agent {
            background: rgba(0, 255, 0, 0.15);
            border-color: var(--color-success);
        }
        
        .test-button.special {
            background: rgba(255, 0, 0, 0.15);
            border-color: var(--color-error);
        }
        
        .agent-section {
            background: rgba(84, 252, 188, 0.02);
            border: 1px solid rgba(84, 252, 188, 0.2);
            border-radius: 5px;
            padding: 30px;
            margin-bottom: 30px;
            display: none;
        }
        
        .agent-section.active {
            display: block;
        }
        
        .chat-messages {
            max-height: 300px;
            overflow-y: auto;
            margin: 25px 0;
        }
        
        .message {
            background: rgba(84, 252, 188, 0.02);
            padding: 20px;
            border-radius: 3px;
            margin-bottom: 15px;
            line-height: 1.8;
        }
        
        .feedback-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 30, 30, 0.98);
            border: 3px solid var(--color-error);
            padding: 60px;
            border-radius: 5px;
            font-size: 2rem;
            font-weight: bold;
            z-index: 1000;
            display: none;
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.6);
            color: var(--color-error);
        }
        
        .feedback-box.show {
            display: block;
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { margin-left: 0; margin-top: 0; }
            10%, 90% { margin-left: -10px; }
            20%, 80% { margin-left: 10px; }
            30%, 50%, 70% { margin-left: -10px; }
            40%, 60% { margin-left: 10px; }
        }
        
        .complete-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 28, 15, 0.85);
            z-index: 999;
            display: none;
        }
        
        .complete-overlay.show {
            display: block;
        }
        
        .complete-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 30, 30, 0.98);
            border: 3px solid var(--color-primary);
            padding: 60px;
            border-radius: 5px;
            text-align: center;
            display: none;
            box-shadow: 0 0 50px rgba(84, 252, 188, 0.6);
            z-index: 1000;
        }
        
        .complete-box.show {
            display: block;
        }
        
        .complete-box h2 {
            font-size: 3rem;
            margin-bottom: 30px;
            color: var(--color-primary);
            letter-spacing: 3px;
        }
        
        .complete-box p {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--color-primary);
            line-height: 1.8;
        }
        
        /* Hint Popup Overlay */
        .hint-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 28, 15, 0.85);
            z-index: 999;
            display: none;
        }
        
        .hint-overlay.show {
            display: block;
        }
        
        .hint-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 30, 30, 0.98);
            border: 3px solid var(--color-primary);
            padding: 60px;
            border-radius: 5px;
            text-align: center;
            display: none;
            box-shadow: 0 0 50px rgba(84, 252, 188, 0.6);
            z-index: 1000;
            min-width: 500px;
        }
        
        .hint-box.show {
            display: block;
            animation: hintPulse 0.5s ease-out;
        }
        
        @keyframes hintPulse {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.05); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .hint-box h2 {
            font-size: 2.5rem;
            margin-bottom: 30px;
            color: var(--color-primary);
            letter-spacing: 3px;
            font-family: var(--font-heading);
        }
        
        .hint-box p {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--color-primary);
            line-height: 1.8;
            font-family: var(--font-body);
        }
        
        .hint-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 30px;
            display: block;
            fill: var(--color-primary);
            filter: drop-shadow(0 0 20px rgba(84, 252, 188, 0.6));
        }
        
        /* Agent Scan Popup */
        .agent-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 28, 15, 0.85);
            z-index: 999;
            display: none;
        }
        
        .agent-overlay.show {
            display: block;
        }
        
        .agent-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 30, 30, 0.98);
            border: 3px solid var(--color-primary);
            padding: 60px;
            border-radius: 5px;
            text-align: center;
            display: none;
            box-shadow: 0 0 50px rgba(84, 252, 188, 0.6);
            z-index: 1000;
            min-width: 500px;
        }
        
        .agent-box.show {
            display: block;
            animation: hintPulse 0.5s ease-out;
        }
        
        .agent-box h2 {
            font-size: 2.5rem;
            margin-bottom: 30px;
            color: var(--color-primary);
            letter-spacing: 3px;
            font-family: var(--font-heading);
        }
        
        .agent-box p {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--color-primary);
            line-height: 1.8;
            font-family: var(--font-body);
        }
        
        .agent-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 30px;
            display: block;
            fill: var(--color-primary);
            filter: drop-shadow(0 0 20px rgba(84, 252, 188, 0.6));
        }
        
        .big-button {
            background: var(--color-bg);
            color: var(--color-primary);
            border: 2px solid var(--color-primary);
            padding: 20px 50px;
            border-radius: 3px;
            font-size: 1.5rem;
            font-weight: bold;
            font-family: 'Blender', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
        }
        
        .big-button:hover {
            background: rgba(84, 252, 188, 0.1);
            border-color: var(--color-primary);
            box-shadow: 0 0 30px rgba(84, 252, 188, 0.4);
            transform: translateY(-2px);
        }
        
        /* Notification bar styling */
        .notification-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 30, 30, 0.98);
            border-top: 3px solid var(--color-primary);
            padding: 40px;
            text-align: center;
            z-index: 2000;
            font-family: 'Courier New', Courier, monospace;
            display: none;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .notification-bar.show {
            display: block;
            transform: translateY(0);
        }
        
        .notification-bar.error {
            border-top-color: var(--color-error);
        }
        
        .notification-bar.success {
            border-top-color: var(--color-success);
        }
        
        .notification-message {
            font-size: 1.5rem;
            margin-bottom: 30px;
            letter-spacing: 2px;
            color: var(--color-primary);
            line-height: 1.8;
            font-family: var(--font-body);
        }
        
        .notification-buttons {
            display: flex;
            gap: 30px;
            justify-content: center;
        }
        
        .notification-btn {
            padding: 18px 45px;
            font-size: 1.2rem;
            font-family: 'Courier New', Courier, monospace;
            border: 2px solid var(--color-primary);
            background: rgba(84, 252, 188, 0.1);
            color: var(--color-primary);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .notification-btn:hover {
            background: rgba(84, 252, 188, 0.2);
            box-shadow: 0 0 15px rgba(84, 252, 188, 0.4);
        }
        
        .notification-btn.yes {
            border-color: var(--color-success);
            color: var(--color-success);
        }
        
        .notification-btn.no {
            border-color: var(--color-error);
            color: var(--color-error);
        }
        
        /* === WEATHER EFFECTS === */
        .lightning-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .lightning-container.behind { z-index: 0; }
        .lightning-container.front { z-index: 9999; }

        .lightning-flash.soft {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, 
                rgba(255, 255, 255, 0.3) 0%, 
                rgba(84, 252, 188, 0.2) 20%, 
                rgba(84, 252, 188, 0.1) 40%, 
                transparent 60%);
            opacity: 0;
            animation: lightning-strike-soft 0.4s ease-out;
        }

        .lightning-flash.medium {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, 
                rgba(255, 255, 255, 0.6) 0%, 
                rgba(84, 252, 188, 0.4) 25%, 
                rgba(84, 252, 188, 0.2) 50%, 
                transparent 75%);
            opacity: 0;
            animation: lightning-strike 0.4s ease-out;
        }

        .lightning-flash.intense {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, 
                rgba(255, 255, 255, 0.95) 0%, 
                rgba(255, 255, 255, 0.8) 30%, 
                rgba(84, 252, 188, 0.6) 50%, 
                rgba(84, 252, 188, 0.3) 70%, 
                transparent 90%);
            opacity: 0;
            animation: lightning-strike-intense 0.3s ease-out;
        }

        @keyframes lightning-strike-soft {
            0% { opacity: 0; }
            15% { opacity: 1; }
            30% { opacity: 0; }
            45% { opacity: 0.6; }
            100% { opacity: 0; }
        }

        @keyframes lightning-strike {
            0% { opacity: 0; }
            10% { opacity: 1; }
            20% { opacity: 0; }
            30% { opacity: 0.8; }
            40% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        @keyframes lightning-strike-intense {
            0% { opacity: 0; }
            5% { opacity: 1; }
            10% { opacity: 0.3; }
            15% { opacity: 1; }
            25% { opacity: 0; }
            30% { opacity: 0.9; }
            100% { opacity: 0; }
        }

        .lightning-bolt-svg {
            position: absolute;
            top: 0;
            opacity: 0;
            animation: bolt-strike 0.3s ease-out;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.8)) 
                    drop-shadow(0 0 20px rgba(84, 252, 188, 0.6));
        }

        @keyframes bolt-strike {
            0% { opacity: 0; }
            20% { opacity: 1; }
            40% { opacity: 0; }
            60% { opacity: 1; }
            100% { opacity: 0; }
        }

        .rain-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9998;
            overflow: hidden;
        }

        .raindrop {
            position: absolute;
            width: 2px;
            height: 20px;
            background: linear-gradient(to bottom, 
                transparent 0%, 
                rgba(84, 252, 188, 0.4) 50%, 
                rgba(84, 252, 188, 0.8) 100%);
            opacity: 0.7;
            animation: rain-fall linear infinite;
        }

        @keyframes rain-fall {
            0% { transform: translateY(-100px); }
            100% { transform: translateY(calc(100vh + 100px)); }
        }

        .raindrop-stuck {
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, 
                rgba(84, 252, 188, 0.6) 0%, 
                rgba(84, 252, 188, 0.3) 60%, 
                transparent 100%);
            border-radius: 50% 50% 40% 40%;
            opacity: 0;
            animation: drop-stick 0.3s ease-out forwards, drop-flow 2s ease-in 0.3s forwards;
        }

        @keyframes drop-stick {
            0% { opacity: 0; transform: scale(0.5); }
            100% { opacity: 0.8; transform: scale(1); }
        }

        @keyframes drop-flow {
            0% { transform: translateY(0) scale(1); opacity: 0.8; }
            100% { transform: translateY(100px) scale(0.3); opacity: 0; }
        }

        .raindrop-streak {
            position: absolute;
            width: 3px;
            height: 0px;
            background: linear-gradient(to bottom, 
                rgba(84, 252, 188, 0.6) 0%, 
                rgba(84, 252, 188, 0.2) 100%);
            opacity: 0;
            animation: streak-flow 1.5s ease-in forwards;
        }

        @keyframes streak-flow {
            0% { height: 0px; opacity: 0.6; }
            50% { height: 80px; opacity: 0.8; }
            100% { height: 150px; opacity: 0; transform: translateY(50px); }
        }
    </style>
</head>
<body>
    <!-- Weather Effect Containers -->
    <div class="lightning-container" id="lightningContainer"></div>
    <div class="rain-container" id="rainContainer"></div>
    
    <div class="game-container">
        <div class="header">
            <div class="header-content">
                <img src="/static/robot-mascot.png" alt="Robot Detective" class="robot-logo">
                <h1>
                    <span class="title-line-1">WHO 
                        <span class="split-container">
                            <span class="split-top">KILLED</span>
                            <span class="split-bottom" aria-hidden="true">KILLED</span>
                        </span> THE
                    </span>
                    <span class="title-line-2">POWER BI DASHBOARD?</span>
                </h1>
                <img src="/static/robot-mascot.png" alt="Robot Detective" class="robot-logo flipped">
            </div>
        </div>
        
        <div class="timer-box" id="timer">
            <span id="timeDisplay">00:00</span>
            <div class="penalty-counter" id="penaltyCounter" style="display: none;"></div>
            <div class="team-name-box" id="teamNameBox" style="display: none;">
                <div class="team-name-label">Team</div>
                <div class="team-name-value" id="teamName">Team Alpha</div>
            </div>
        </div>
        
        <div class="situatie-box" id="situatie">
            Loading...
        </div>
        
        <div class="scenario-box" id="scenario">
            Loading scenario...
        </div>
        
        <div class="answer-section">
            <div class="answer-box" id="box-who">
                <svg class="answer-icon" viewBox="0 0 512 512">
                    <path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="32" d="M256 304c-87 0-175.3 48-191.64 138.6C62.39 453.52 68.57 464 80 464h352c11.44 0 17.62-10.48 15.65-21.4C431.3 352 343 304 256 304z"/>
                    <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M344 144c-3.92 52.87-44 96-88 96s-84.15-43.12-88-96c-4-55 35-96 88-96s92 42 88 96z"/>
                </svg>
                <div class="answer-label">WIE?</div>
                <div class="answer-subtitle">(PERSOON)</div>
                <div class="answer-value" id="answer-who">???</div>
            </div>
            <div class="answer-box" id="box-waarmee">
                <svg class="answer-icon" viewBox="0 0 256 256">
                    <path fill="currentColor" d="M231.87,32.13a27.84,27.84,0,0,0-39.32,0L18.34,206.4a8,8,0,0,0,3.86,13.45A160.67,160.67,0,0,0,58.4,224c32.95,0,65.92-10.2,96.95-30.23,31.76-20.5,50.19-43.82,51-44.81a8,8,0,0,0-.64-10.59L185.32,118l46.55-46.56A27.85,27.85,0,0,0,231.87,32.13ZM189.1,144.44a220.41,220.41,0,0,1-42.86,36.16c-34.43,22.1-69.94,30.92-105.77,26.3L146,101.33Zm31.46-84.3L174,106.7,157.32,90l46.55-46.56a11.8,11.8,0,0,1,16.69,16.69Z"/>
                </svg>
                <div class="answer-label">WAARMEE?</div>
                <div class="answer-subtitle">(WAPEN)</div>
                <div class="answer-value" id="answer-waarmee">???</div>
            </div>
            <div class="answer-box" id="box-waar">
                <svg class="answer-icon" viewBox="0 0 512 512">
                    <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M256 48c-79.5 0-144 61.39-144 137 0 87 96 224.87 131.25 272.49a15.77 15.77 0 0 0 25.5 0C304 409.89 400 272.07 400 185c0-75.61-64.5-137-144-137z"/>
                    <circle cx="256" cy="192" r="48" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"/>
                </svg>
                <div class="answer-label">WAAR?</div>
                <div class="answer-subtitle">(LOCATIE)</div>
                <div class="answer-value" id="answer-waar">???</div>
            </div>
        </div>
        
        <!-- TEST MODE BUTTONS -->
        <div class="test-buttons" id="testButtons">
            <h3>üß™ DEV CONTROLS</h3>
            
            <div class="button-group">
                <strong>Personen:</strong>
                <button class="test-button" onclick="testScan('3032948996')">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    Power BI Developer
                </button>
                <button class="test-button" onclick="testScan('TEMP_NFC_PERSON_04')">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    Financial Controller
                </button>
                <button class="test-button" onclick="testScan('0458378500')">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    Database Beheerder
                </button>
            </div>
            
            <div class="button-group">
                <strong>Wapens:</strong>
                <button class="test-button" onclick="testScan('TEMP_NFC_WEAPON_1')">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    Inactieve Relatie
                </button>
                <button class="test-button" onclick="testScan('TEMP_NFC_WEAPON_2')">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    Hidden Slicer
                </button>
                <button class="test-button" onclick="testScan('TEMP_NFC_WEAPON_3')">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    Dubbele Records
                </button>
                <button class="test-button" onclick="testScan('TEMP_NFC_WEAPON_4')">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    Hardcoded Pad
                </button>
                <button class="test-button" onclick="testScan('TEMP_NFC_WEAPON_5')">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    Budget Niet Updated
                </button>
                <button class="test-button" onclick="testScan('TEMP_NFC_WEAPON_6')">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    Kolomnaam Gewijzigd
                </button>
                <button class="test-button" onclick="testScan('TEMP_NFC_WEAPON_7')">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    Refresh Uitgeschakeld
                </button>
            </div>
            
            <div class="button-group">
                <strong>Locaties:</strong>
                <button class="test-button" onclick="testScan('TEMP_NFC_LOCATION_1')">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                    OneDrive
                </button>
                <button class="test-button" onclick="testScan('TEMP_NFC_LOCATION_2')">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                    Power Query Editor
                </button>
                <button class="test-button" onclick="testScan('TEMP_NFC_LOCATION_3')">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                    Semantisch Model
                </button>
                <button class="test-button" onclick="testScan('TEMP_NFC_LOCATION_4')">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                    Report View - Selection Pane
                </button>
                <button class="test-button" onclick="testScan('TEMP_NFC_LOCATION_DATABASE')">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                    Database
                </button>
            </div>
            
            <div class="button-group">
                <strong>Agents:</strong>
                <button class="test-button agent" onclick="testScan('0526206468')">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1"/>
                        <circle cx="12" cy="5" r="1"/>
                        <circle cx="12" cy="19" r="1"/>
                    </svg>
                    De Schoonmaker
                </button>
                <button class="test-button agent" onclick="testScan('0480142596')">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1"/>
                        <circle cx="12" cy="5" r="1"/>
                        <circle cx="12" cy="19" r="1"/>
                    </svg>
                    De Receptionist
                </button>
                <button class="test-button agent" onclick="testScan('0416094468')">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1"/>
                        <circle cx="12" cy="5" r="1"/>
                        <circle cx="12" cy="19" r="1"/>
                    </svg>
                    De Stagiair
                </button>
            </div>
            
            <div class="button-group">
                <strong>Special:</strong>
                <button class="test-button special" onclick="handleExitGame()">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    EXIT
                </button>
                <button class="test-button special" onclick="handleResetApp()">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"/>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                    RESET
                </button>
            </div>
            
            <div class="button-group">
                <strong>Standbeheerder:</strong>
                <button class="test-button special" onclick="handleNotificationYes()">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    YES
                </button>
                <button class="test-button special" onclick="handleNotificationNo()">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                    NO
                </button>
            </div>
            
            <div class="button-group">
                <strong>‚ö†Ô∏è DEV ONLY:</strong>
                <button class="test-button special" onclick="forceReset()" style="background: rgba(245, 87, 108, 0.3);">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
                    </svg>
                    FORCE RESET
                </button>
            </div>
        </div>
        
        <div class="agent-section" id="agentSection">
            <h2 id="agentName">Agent</h2>
            <p id="agentBio"></p>
            <div class="chat-messages" id="chatMessages"></div>
            <p style="text-align: center; margin-top: 20px;">
                <em>üí¨ Scan Agent pasje opnieuw om AI chat te openen (via n8n)</em>
            </p>
        </div>
        
        <div class="feedback-box" id="feedbackBox">
            FOUT! +15 SECONDEN
        </div>
        
        <div class="complete-overlay" id="completeOverlay"></div>
        
        <div class="hint-overlay" id="hintOverlay"></div>
        
        <div class="agent-overlay" id="agentOverlay"></div>
        
        <div class="hint-box" id="hintBox">
            <svg class="hint-icon" viewBox="0 0 352 512">
                <path d="M176 80c-52.94 0-96 43.06-96 96 0 8.84 7.16 16 16 16s16-7.16 16-16c0-35.3 28.72-64 64-64 8.84 0 16-7.16 16-16s-7.16-16-16-16zM96.06 459.17c0 3.15.93 6.22 2.68 8.84l24.51 36.84c2.97 4.46 7.97 7.14 13.32 7.14h78.85c5.36 0 10.36-2.68 13.32-7.14l24.51-36.84c1.74-2.62 2.67-5.7 2.68-8.84l.05-43.18H96.02l.04 43.18zM176 0C73.72 0 0 82.97 0 176c0 44.37 16.45 84.85 43.56 115.78 16.64 18.99 42.74 58.8 52.42 92.16v.06h48v-.12c-.01-4.77-.72-9.51-2.15-14.07-5.59-17.81-22.82-64.77-62.17-109.67-20.54-23.43-31.52-53.15-31.61-84.14-.2-73.64 59.67-128 127.95-128 70.58 0 128 57.42 128 128 0 30.97-11.24 60.85-31.65 84.14-39.11 44.61-56.42 91.47-62.1 109.46a47.507 47.507 0 0 0-2.22 14.3v.1h48v-.05c9.68-33.37 35.78-73.18 52.42-92.16C335.55 260.85 352 220.37 352 176 352 78.8 273.2 0 176 0z"></path>
            </svg>
            <h2>HINT</h2>
            <p>Zoek op de stand naar getuigen<br>om mee te 'praten'</p>
            <p style="font-size: 1.2rem; opacity: 0.8; margin-top: 10px;">(Gebruik je telefoon om de NFC-tags te scannen)</p>
        </div>
        
        <div class="agent-box" id="agentBox">
            <svg class="agent-icon" viewBox="0 0 24 24">
                <path d="M12.596 2.043c1.075.076 2.059.281 2.743.956.698.688.92 1.696.92 2.941 0 .432-.057.955-.117 1.438-.026.2-.051.392-.076.572l-.056.429h2.05c.752 0 1.446.108 2.036.404.612.306 1.062.787 1.355 1.431.551 1.214.542 3.008.223 5.394l-.051.39c-.134 1.01-.248 1.872-.396 2.58-.166.795-.394 1.496-.816 2.05-.89 1.168-2.395 1.372-4.583 1.372-2.331 0-4.08-.418-5.544-.824l-.602-.17c-1.023-.29-1.852-.526-2.69-.586A1.75 1.75 0 0 1 5.25 22h-1.5A1.75 1.75 0 0 1 2 20.25V9.75C2 8.784 2.784 8 3.75 8h1.5a1.75 1.75 0 0 1 1.746 1.633 1.85 1.85 0 0 0 .523-.131c.961-.415 2.774-1.534 2.774-4.2V4.249c0-1.22 1.002-2.298 2.303-2.206ZM7 18.918c1.059.064 2.079.355 3.118.652l.568.16c1.406.39 3.006.77 5.142.77 2.277 0 3.004-.274 3.39-.781.216-.283.388-.718.54-1.448.136-.65.242-1.45.379-2.477l.05-.384c.32-2.4.253-3.795-.102-4.575-.16-.352-.375-.568-.66-.711-.305-.153-.74-.245-1.365-.245h-2.37c-.681 0-1.293-.57-1.211-1.328.026-.243.065-.537.105-.834l.07-.527c.06-.482.105-.921.105-1.25 0-1.125-.213-1.617-.473-1.873-.275-.27-.774-.455-1.795-.528-.351-.024-.698.274-.698.71v1.053c0 3.55-2.488 5.063-3.68 5.577-.372.16-.754.232-1.113.26ZM3.75 20.5h1.5a.25.25 0 0 0 .25-.25V9.75a.25.25 0 0 0-.25-.25h-1.5a.25.25 0 0 0-.25.25v10.5c0 .138.112.25.25.25Z"></path>
            </svg>
            <h2>GETUIGE GEVONDEN</h2>
            <p>Gebruik je telefoon om de tag<br>te scannen, en chat met de getuige</p>
        </div>
        
        <div class="complete-box" id="completeBox">
            <h2>GEFELICITEERD!</h2>
            <p id="finalTime"></p>
            <p id="penaltyInfo"></p>
            <button class="big-button" onclick="showLeaderboard()">Bekijk Leaderboard</button>
        </div>
        
        <div class="notification-bar" id="notificationBar">
            <h3 id="notificationTitle">‚ö†Ô∏è Spel Be√´indigen?</h3>
            <p id="notificationMessage">Weet je zeker dat je het spel wilt stoppen?</p>
            <div class="notification-buttons">
                <button class="yes" onclick="handleNotificationYes()">‚úì YES (of scan YES pasje)</button>
                <button class="no" onclick="handleNotificationNo()">‚úó NO (of scan NO pasje)</button>
            </div>
        </div>
    </div>
    
    <script>
        let gameId = null;
        let startTime = null;
        let timerInterval = null;
        let currentStep = 'WHO'; // WHO -> WAARMEE -> WAAR
        let penalties = 0;
        
        // Start game on page load
        window.onload = async () => {
            await startNewGame();
            // Focus window to capture keyboard input
            window.focus();
            
            // Enable dev mode if ?dev=true in URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('dev') === 'true') {
                document.querySelector('.scenario-box').classList.add('dev-mode');
            }
        };
        
        // Listen for NFC keyboard input (cijfer + Enter)
        let nfcBuffer = '';
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && nfcBuffer.length > 0) {
                handleNFCScan(nfcBuffer);
                nfcBuffer = '';
            } else if (e.key >= '0' && e.key <= '9') {
                nfcBuffer += e.key;
            }
        });
        
        async function startNewGame() {
            console.log('üéÆ Starting new game...');
            try {
                // Clear any leftover notifications from previous game
                hideNotification();
                
                // Reset penalties for new game
                penalties = 0;
                updatePenaltyDisplay();
                
                // Check if we already have a session from START scan
                const existingSessionCode = localStorage.getItem('sessionCode');
                
                if (existingSessionCode) {
                    console.log('‚úÖ Using existing session from START scan:', existingSessionCode);
                    
                    // Get the game details from the existing session
                    const sessionResponse = await fetch(`/api/game/session/${existingSessionCode}`);
                    if (sessionResponse.ok) {
                        const sessionData = await sessionResponse.json();
                        console.log('Session data:', sessionData);
                        
                        gameId = sessionData.game_id;
                        document.getElementById('scenario').innerHTML = sessionData.scenario;
                        document.getElementById('situatie').innerHTML = sessionData.situatie_beschrijving || 'Er is een probleem met het Power BI Dashboard...';
                        
                        // Show team name
                        if (sessionData.team_name) {
                            document.getElementById('teamName').textContent = sessionData.team_name;
                            document.getElementById('teamNameBox').style.display = 'block';
                        }
                        
                        startTimer();
                        startRandomWeather();
                        return;
                    } else {
                        console.warn('Session not found, creating new game...');
                        localStorage.removeItem('sessionCode');
                    }
                }
                
                // No existing session - create new game
                const response = await fetch('/api/game/start', {
                    method: 'POST'
                });
                
                console.log('Start game response status:', response.status);
                
                if (response.status === 409) {
                    // Conflict - active scenario exists
                    console.warn('‚ö†Ô∏è Active game already exists');
                    const errorData = await response.json();
                    console.log('Conflict data:', errorData);
                    
                    // Check if we got a game_id anyway
                    if (errorData.game_id) {
                        console.log('‚úÖ Using existing game_id:', errorData.game_id);
                        gameId = errorData.game_id;
                        // Try to load scenario info
                        if (errorData.scenario) {
                            document.getElementById('scenario').innerHTML = errorData.scenario;
                        }
                    } else {
                        showNotification('‚ö†Ô∏è Actief Spel', 'Er is al een actief spel. Scan EXIT om te stoppen, of gebruik Force Reset knop.', 'error');
                    }
                    return;
                }
                
                const data = await response.json();
                console.log('Start game data:', data);
                
                if (data.success) {
                    gameId = data.game_id;
                    console.log('‚úÖ New game started with ID:', gameId);
                    localStorage.setItem('sessionCode', data.session_code);
                    document.getElementById('scenario').innerHTML = data.scenario;
                    document.getElementById('situatie').innerHTML = data.situatie_beschrijving || 'Er is een probleem met het Power BI Dashboard...';
                    
                    // Show team name
                    if (data.team_name) {
                        document.getElementById('teamName').textContent = data.team_name;
                        document.getElementById('teamNameBox').style.display = 'block';
                    }
                    
                    startTimer();
                    
                    // Start random weather effects
                    startRandomWeather();
                } else {
                    console.error('‚ùå Game start failed:', data.message);
                    showNotification('‚ùå Fout', data.message || 'Kon spel niet starten', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error starting game:', error);
                showNotification('‚ùå Fout', 'Kon geen verbinding maken met server', 'error');
            }
        }
        
        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timeDisplay').textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }
        
        async function handleNFCScan(code) {
            console.log('üì° handleNFCScan called with:', code);
            console.log('   gameId:', gameId);
            
            try {
                console.log('‚Üí Sending POST to /api/game/scan');
                const response = await fetch('/api/game/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        game_id: gameId,
                        nfc_code: code 
                    })
                });
                const data = await response.json();
                console.log('‚Üê Response:', data);
                
                if (data.success) {
                    // Check for special codes first (these work without game_id)
                    if (data.type === 'special' && data.data && data.data.code_type) {
                        const codeType = data.data.code_type;
                        console.log('Special code detected:', codeType);
                        
                        switch(codeType) {
                            case 'EXIT':
                                handleExitGame();
                                return;
                            case 'RESET':
                                handleResetApp();
                                return;
                            case 'YES':
                                handleNotificationYes();
                                return;
                            case 'NO':
                                handleNotificationNo();
                                return;
                        }
                    }
                    
                    // For non-special codes, require game_id
                    if (!gameId) {
                        console.error('‚ùå Cannot scan - no active game');
                        showNotification('‚ö†Ô∏è Geen Actief Spel', 'Game ID is niet ge√Ønitialiseerd', 'error');
                        return;
                    }
                    
                    processScannedItem(data);
                } else {
                    showNotification('‚ùå Ongeldige Scan', data.message || 'Code niet herkend', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error in handleNFCScan:', error);
                showNotification('‚ùå Scan Error', error.message, 'error');
            }
        }
        
        function testScan(code) {
            console.log('üß™ Test scan:', code);
            console.log('   Current gameId:', gameId);
            
            // Check if we have a game running
            if (!gameId && !code.startsWith('TEMP_NFC_START') && !code.startsWith('TEMP_NFC_RESET')) {
                console.error('‚ùå Geen actief spel! Start eerst een nieuw spel.');
                showNotification('‚ö†Ô∏è Geen Actief Spel', 'Scan START om een nieuw spel te beginnen', 'error');
                return;
            }
            
            // Special codes kunnen direct afgehandeld worden of via API
            if (code === 'TEMP_NFC_START') {
                // Start nieuw spel - reload page to trigger startNewGame()
                window.location.reload();
            } else if (code === 'TEMP_NFC_EXIT') {
                handleExitGame();
            } else if (code === 'TEMP_NFC_RESET') {
                handleResetApp();
            } else if (code === 'TEMP_NFC_YES') {
                handleNotificationYes();
            } else if (code === 'TEMP_NFC_NO') {
                handleNotificationNo();
            } else {
                // Normale NFC codes gaan via API
                console.log('‚Üí Calling handleNFCScan with code:', code);
                handleNFCScan(code);
            }
        }
        
        async function processScannedItem(data) {
            const type = data.type;
            
            if (type === 'persoon' || type === 'wapen' || type === 'locatie') {
                // Answer submission
                const response = await fetch('/api/game/answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        game_id: gameId,
                        type: type,
                        value: data.name
                    })
                });
                const result = await response.json();
                
                if (result.success) {
                    // Update the answer box
                    const boxId = type === 'persoon' ? 'box-who' : 
                                 type === 'wapen' ? 'box-waarmee' : 'box-waar';
                    const answerId = type === 'persoon' ? 'answer-who' : 
                                    type === 'wapen' ? 'answer-waarmee' : 'answer-waar';
                    
                    document.getElementById(boxId).classList.add('filled');
                    document.getElementById(answerId).textContent = data.name;
                    
                    if (!result.all_filled) {
                        // Just recorded, waiting for all 3
                        console.log('Answer recorded:', data.name);
                    } else if (result.completed) {
                        // ALL CORRECT - GAME WON!
                        // Make all boxes green
                        document.getElementById('box-who').classList.add('correct');
                        document.getElementById('box-waarmee').classList.add('correct');
                        document.getElementById('box-waar').classList.add('correct');
                        
                        clearInterval(timerInterval);
                        stopRandomWeather(); // Stop weather effects bij win
                        document.getElementById('finalTime').textContent = 
                            `Totale tijd: ${result.total_time}`;
                        document.getElementById('penaltyInfo').textContent = 
                            `Penalties: ${penalties} x 15 sec`;
                        
                        // Verwijder groene borders en toon overlay + popup
                        setTimeout(() => {
                            document.getElementById('box-who').classList.remove('correct');
                            document.getElementById('box-waarmee').classList.remove('correct');
                            document.getElementById('box-waar').classList.remove('correct');
                            document.getElementById('completeOverlay').classList.add('show');
                            document.getElementById('completeBox').classList.add('show');
                        }, 500);
                        
                        // Auto-navigatie naar leaderboard na 5 seconden
                        setTimeout(() => {
                            console.log('Navigating to leaderboard...');
                            window.location.href = '/leaderboard';
                        }, 5000);
                    } else {
                        // ALL FILLED BUT WRONG - Show red and reset
                        document.getElementById('box-who').classList.add('wrong');
                        document.getElementById('box-waarmee').classList.add('wrong');
                        document.getElementById('box-waar').classList.add('wrong');
                        
                        penalties++;
                        updatePenaltyDisplay();
                        showFeedback();
                        
                        // Show hint after 2nd and 4th wrong attempt
                        if (penalties === 2 || penalties === 4) {
                            showHintNotification();
                        }
                        
                        // Clear boxes after 2 seconds - remove wrong class to make fillable again
                        setTimeout(() => {
                            document.getElementById('box-who').classList.remove('filled', 'wrong');
                            document.getElementById('box-waarmee').classList.remove('filled', 'wrong');
                            document.getElementById('box-waar').classList.remove('filled', 'wrong');
                            document.getElementById('answer-who').textContent = '???';
                            document.getElementById('answer-waarmee').textContent = '???';
                            document.getElementById('answer-waar').textContent = '???';
                        }, 2000);
                    }
                }
            } else if (type === 'agent') {
                // Show agent popup - instrueert om telefoon te gebruiken
                showAgentNotification();
                
                // Get hint context for n8n (achtergrond)
                const hintResponse = await fetch(`/api/agent/hint?game_id=${gameId}&agent_nfc=${data.nfc_code}`);
                const hintData = await hintResponse.json();
                console.log('Agent hint context:', hintData);
            } else if (type === 'special') {
                const codeType = data.code_type;
                if (codeType === 'EXIT') {
                    // EXIT OVERRULET ALLES - altijd force reset
                    hideNotification(); // Verberg alle notificaties
                    
                    // Force reset om oude games te clearen
                    await fetch('/api/game/force-reset', {
                        method: 'POST'
                    });
                    
                    // Als er een gameId is, probeer ook exit
                    if (gameId) {
                        await fetch('/api/game/exit', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ game_id: gameId })
                        });
                    }
                    
                    // Ga naar home
                    window.location.href = '/';
                } else if (codeType === 'RESET') {
                    // RESET OVERRULET ALLES - altijd force reset + naar home
                    hideNotification(); // Verberg alle notificaties
                    // Abort current game before going to homepage
                    if (gameId) {
                        await fetch('/api/game/exit', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ game_id: gameId })
                        });
                    }
                    window.location.href = '/';
                } else if (codeType === 'YES') {
                    handleNotificationYes();
                } else if (codeType === 'NO') {
                    handleNotificationNo();
                }
            }
        }
        
        function showFeedback() {
            const box = document.getElementById('feedbackBox');
            box.classList.add('show');
            setTimeout(() => box.classList.remove('show'), 2000);
        }
        
        function updatePenaltyDisplay() {
            const penaltyCounter = document.getElementById('penaltyCounter');
            const totalPenaltySeconds = penalties * 15;
            
            if (penalties > 0) {
                penaltyCounter.textContent = `+${totalPenaltySeconds}`;
                penaltyCounter.style.display = 'block';
            } else {
                penaltyCounter.style.display = 'none';
            }
        }
        
        function showLeaderboard() {
            window.location.href = '/leaderboard';
        }
        
        let currentNotificationAction = null;
        
        function showNotification(title, message, action) {
            currentNotificationAction = action;
            document.getElementById('notificationTitle').textContent = title;
            document.getElementById('notificationMessage').textContent = message;
            
            // Remove all type classes
            const bar = document.getElementById('notificationBar');
            bar.classList.remove('error', 'success');
            
            // Hide YES/NO buttons for error notifications
            if (action === 'error') {
                bar.classList.add('error');
                document.querySelector('.notification-buttons').style.display = 'none';
                bar.classList.add('show');
                // Auto-hide after 3 seconds
                setTimeout(() => {
                    hideNotification();
                }, 3000);
            } else {
                document.querySelector('.notification-buttons').style.display = 'flex';
                bar.classList.add('show');
            }
        }
        
        function showHintNotification() {
            const overlay = document.getElementById('hintOverlay');
            const box = document.getElementById('hintBox');
            
            overlay.classList.add('show');
            box.classList.add('show');
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                hideHintNotification();
            }, 10000);
        }
        
        function hideHintNotification() {
            const overlay = document.getElementById('hintOverlay');
            const box = document.getElementById('hintBox');
            
            overlay.classList.remove('show');
            box.classList.remove('show');
        }
        
        function showAgentNotification() {
            const overlay = document.getElementById('agentOverlay');
            const box = document.getElementById('agentBox');
            
            overlay.classList.add('show');
            box.classList.add('show');
            
            // Auto-hide after 8 seconds
            setTimeout(() => {
                hideAgentNotification();
            }, 8000);
        }
        
        function hideAgentNotification() {
            const overlay = document.getElementById('agentOverlay');
            const box = document.getElementById('agentBox');
            
            overlay.classList.remove('show');
            box.classList.remove('show');
        }
        
        function hideNotification() {
            document.getElementById('notificationBar').classList.remove('show');
            currentNotificationAction = null;
        }
        
        async function handleNotificationYes() {
            // Only act if there's an active notification
            if (!currentNotificationAction) {
                console.log('YES scanned but no active notification');
                return;
            }
            
            if (currentNotificationAction === 'exit') {
                // Exit game and force reset database
                await fetch('/api/game/exit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ game_id: gameId })
                });
                
                // Cleanup active games
                await fetch('/api/game/cleanup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                window.location.href = '/';
            }
            hideNotification();
        }
        
        function handleNotificationNo() {
            // Only act if there's an active notification
            if (!currentNotificationAction) {
                console.log('NO scanned but no active notification');
                return;
            }
            hideNotification();
        }
        
        // Direct handlers for EXIT and RESET buttons
        function handleExitGame() {
            showNotification('‚ö†Ô∏è Spel Be√´indigen?', 'Weet je zeker dat je het spel wilt stoppen?', 'exit');
        }
        
        async function handleResetApp() {
            // Abort current game before going to homepage
            if (gameId) {
                await fetch('/api/game/exit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ game_id: gameId })
                });
            }
            
            // Cleanup active games before going home
            await fetch('/api/game/cleanup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            window.location.href = '/';
        }
        
        async function forceReset() {
            if (confirm('‚ö†Ô∏è FORCE RESET: Dit reset ALLE actieve scenarios en games in de database. Zeker weten?')) {
                try {
                    const response = await fetch('/api/game/force-reset', {
                        method: 'POST'
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('‚úÖ Database gereset! Refresh de pagina.');
                        window.location.reload();
                    } else {
                        alert('‚ùå Reset failed: ' + data.message);
                    }
                } catch (error) {
                    alert('‚ùå Error: ' + error.message);
                }
            }
        }
        
        // === WEATHER EFFECTS ===
        let rainInterval = null;
        let stormInterval = null;
        let randomWeatherInterval = null;
        let rainActive = false;
        let stormActive = false;
        let randomWeatherActive = false;

        function triggerLightning() {
            const container = document.getElementById('lightningContainer');
            const intensities = ['soft', 'medium', 'medium', 'intense'];
            const intensity = intensities[Math.floor(Math.random() * intensities.length)];
            const zPosition = Math.random() > 0.5 ? 'front' : 'behind';
            
            container.className = 'lightning-container ' + zPosition;
            const flash = document.createElement('div');
            flash.className = 'lightning-flash ' + intensity;
            container.appendChild(flash);
            
            if (Math.random() > 0.6) {
                const xPos = Math.random() * 80 + 10;
                createZigzagBolt(container, xPos);
            }
            
            setTimeout(() => {
                flash.remove();
                container.querySelectorAll('.lightning-bolt-svg').forEach(bolt => bolt.remove());
            }, 600);
        }

        function createZigzagBolt(container, xPosition) {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('class', 'lightning-bolt-svg');
            svg.setAttribute('width', '200');
            svg.setAttribute('height', '100vh');
            svg.style.left = xPosition + '%';
            svg.style.transform = 'translateX(-50%)';
            
            let path = 'M 100 0 ';
            let currentX = 100;
            let currentY = 0;
            const segments = Math.floor(Math.random() * 8) + 6;
            const screenHeight = window.innerHeight;
            
            for (let i = 0; i < segments; i++) {
                const offsetX = (Math.random() - 0.5) * 100;
                currentX = Math.max(20, Math.min(180, currentX + offsetX));
                currentY += screenHeight / segments;
                path += `L ${currentX} ${currentY} `;
                
                if (Math.random() > 0.7) {
                    const sharpX = currentX + (Math.random() - 0.5) * 60;
                    const sharpY = currentY + (screenHeight / segments) * 0.3;
                    path += `L ${sharpX} ${sharpY} `;
                    currentX = sharpX;
                    currentY = sharpY;
                }
            }
            
            const pathElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            pathElement.setAttribute('d', path);
            pathElement.setAttribute('stroke', 'rgba(255, 255, 255, 0.9)');
            pathElement.setAttribute('stroke-width', '3');
            pathElement.setAttribute('fill', 'none');
            pathElement.setAttribute('stroke-linecap', 'round');
            
            svg.appendChild(pathElement);
            container.appendChild(svg);
        }

        function startRain() {
            if (rainActive) return;
            rainActive = true;
            const container = document.getElementById('rainContainer');
            rainInterval = setInterval(() => createRaindrop(container), 30);
        }

        function stopRain() {
            rainActive = false;
            if (rainInterval) {
                clearInterval(rainInterval);
                rainInterval = null;
            }
            setTimeout(() => {
                document.querySelectorAll('.raindrop, .raindrop-stuck, .raindrop-streak').forEach(d => d.remove());
            }, 2000);
        }

        function createRaindrop(container) {
            const rand = Math.random();
            
            if (rand > 0.85) {
                createStuckDrop(container);
            } else if (rand > 0.80) {
                createStreakDrop(container);
            } else {
                const drop = document.createElement('div');
                drop.className = 'raindrop';
                drop.style.left = (Math.random() * 100) + '%';
                const duration = Math.random() * 0.5 + 0.5;
                drop.style.animationDuration = duration + 's';
                drop.style.animationDelay = (Math.random() * 0.2) + 's';
                container.appendChild(drop);
                setTimeout(() => drop.remove(), (duration + 0.2) * 1000);
            }
        }

        function createStuckDrop(container) {
            const drop = document.createElement('div');
            drop.className = 'raindrop-stuck';
            drop.style.left = (Math.random() * 100) + '%';
            drop.style.top = (Math.random() * 50) + '%';
            container.appendChild(drop);
            setTimeout(() => drop.remove(), 2500);
        }

        function createStreakDrop(container) {
            const drop = document.createElement('div');
            drop.className = 'raindrop-streak';
            drop.style.left = (Math.random() * 100) + '%';
            drop.style.top = (Math.random() * 40) + '%';
            container.appendChild(drop);
            setTimeout(() => drop.remove(), 1600);
        }

        function triggerStorm() {
            if (stormActive) return;
            stormActive = true;
            
            if (!rainActive) startRain();
            
            stormInterval = setInterval(() => {
                triggerLightning();
                if (Math.random() > 0.7) {
                    setTimeout(() => triggerLightning(), 300);
                }
            }, Math.random() * 7000 + 5000);
        }

        function stopStorm() {
            stormActive = false;
            if (stormInterval) {
                clearInterval(stormInterval);
                stormInterval = null;
            }
        }

        function startRandomWeather() {
            if (randomWeatherActive) return;
            randomWeatherActive = true;
            console.log('üé≤ Random weer gestart');
            triggerStorm();
            scheduleNextWeatherChange();
        }

        function scheduleNextWeatherChange() {
            if (!randomWeatherActive) return;
            const nextChangeIn = Math.random() * 20000 + 10000;
            
            randomWeatherInterval = setTimeout(() => {
                if (!randomWeatherActive) return;
                
                if (Math.random() > 0.4) {
                    if (!stormActive) {
                        console.log('üåßÔ∏è Storm begint...');
                        triggerStorm();
                    }
                } else {
                    if (stormActive || rainActive) {
                        console.log('üå§Ô∏è Storm stopt...');
                        stopStorm();
                        stopRain();
                    }
                }
                scheduleNextWeatherChange();
            }, nextChangeIn);
        }

        function stopRandomWeather() {
            randomWeatherActive = false;
            if (randomWeatherInterval) {
                clearTimeout(randomWeatherInterval);
                randomWeatherInterval = null;
            }
            stopStorm();
            stopRain();
        }

        // Dev Controls Visibility System
        let devControlsTimeout = null;
        let devControlsHideTimeout = null;
        let mouseMovements = [];
        let lastMouseTime = 0;

        function checkMouseMovement(e) {
            const now = Date.now();
            mouseMovements.push(now);
            
            // Keep only last 2 seconds of movements
            mouseMovements = mouseMovements.filter(t => now - t < 2000);
            
            // Check if mouse moved back and forth (at least 5 movements in 2 seconds)
            if (mouseMovements.length >= 5 && now - lastMouseTime > 100) {
                showDevControls();
            }
            
            lastMouseTime = now;
        }

        function showDevControls() {
            const testButtons = document.getElementById('testButtons');
            testButtons.classList.add('dev-visible');
            
            // Clear existing hide timeout
            if (devControlsHideTimeout) {
                clearTimeout(devControlsHideTimeout);
            }
            
            // Auto-hide after 5 seconds
            devControlsHideTimeout = setTimeout(() => {
                hideDevControls();
            }, 5000);
        }

        function hideDevControls() {
            const testButtons = document.getElementById('testButtons');
            testButtons.classList.remove('dev-visible');
            mouseMovements = [];
        }

        // Logo hover to show dev controls
        document.addEventListener('DOMContentLoaded', () => {
            const footerLogo = document.querySelector('.footer-logo');
            if (footerLogo) {
                footerLogo.addEventListener('mouseenter', showDevControls);
            }
            
            // Track mouse movement
            document.addEventListener('mousemove', checkMouseMovement);
        });
    </script>
    
    <img src="{{ url_for('static', filename='AD-Sticker-Shape.png') }}" alt="Another Dimension" class="footer-logo">
</body>
</html>
